# WhatsApp - Sess√µes e Eventos (Issue #36)

## üìã √çndice
- [Vis√£o Geral](#vis√£o-geral)
- [Modelos de Dados](#modelos-de-dados)
- [Endpoints API](#endpoints-api)
- [WebSocket](#websocket)
- [M√©tricas de Lat√™ncia](#m√©tricas-de-lat√™ncia)
- [Exemplos de Uso](#exemplos-de-uso)

---

## üéØ Vis√£o Geral

Sistema completo de gerenciamento de sess√µes WhatsApp Web com persist√™ncia em banco de dados e m√©tricas de lat√™ncia em tempo real.

### Funcionalidades Implementadas

‚úÖ **Modelos de Persist√™ncia**
- `WhatsAppSession`: Gerenciamento de sess√µes WhatsApp
- `WhatsAppMessage`: Hist√≥rico completo de mensagens

‚úÖ **Gest√£o de Sess√µes**
- Iniciar/Parar sess√µes WhatsApp
- Consultar status em tempo real
- Rastreamento de uptime e m√©tricas

‚úÖ **Mensagens**
- Envio de mensagens (texto, imagem, √°udio, etc)
- Recebimento e persist√™ncia de mensagens
- Atualiza√ß√£o de status (queued ‚Üí sent ‚Üí delivered ‚Üí read)

‚úÖ **M√©tricas de Lat√™ncia**
- C√°lculo autom√°tico de lat√™ncia em milissegundos
- Alertas para lat√™ncias > 5 segundos
- Estat√≠sticas agregadas de desempenho

‚úÖ **WebSocket em Tempo Real**
- Eventos de sess√£o (connecting, qrcode, ready, etc)
- Eventos de mensagens
- Persist√™ncia autom√°tica no banco

---

## üìä Modelos de Dados

### WhatsAppSession

Representa uma sess√£o WhatsApp Web conectada.

#### Campos Principais

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `usuario` | FK | Usu√°rio respons√°vel pela sess√£o |
| `status` | CharField | Status da sess√£o (disconnected, connecting, qrcode, authenticated, ready, error) |
| `device_name` | CharField | Nome do dispositivo conectado |
| `phone_number` | CharField | N√∫mero do WhatsApp conectado |
| `qr_code` | TextField | QR Code em base64 (quando dispon√≠vel) |
| `connected_at` | DateTime | Data/hora da √∫ltima conex√£o |
| `total_messages_sent` | Integer | Total de mensagens enviadas |
| `total_messages_received` | Integer | Total de mensagens recebidas |
| `error_count` | Integer | Contador de erros |

#### Propriedades

- `is_connected`: Retorna `True` se status == 'ready' e is_active == True
- `uptime_seconds`: Tempo de atividade desde a conex√£o em segundos

#### M√©todos

- `mark_as_connected()`: Marca sess√£o como conectada (ready)
- `mark_as_disconnected()`: Marca sess√£o como desconectada
- `mark_as_error(error_message)`: Marca sess√£o com erro
- `increment_sent_messages()`: Incrementa contador de mensagens enviadas
- `increment_received_messages()`: Incrementa contador de mensagens recebidas

---

### WhatsAppMessage

Representa uma mensagem enviada ou recebida via WhatsApp.

#### Campos Principais

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `session` | FK | Sess√£o WhatsApp associada |
| `usuario` | FK | Usu√°rio respons√°vel |
| `message_id` | CharField | ID √∫nico da mensagem |
| `direction` | CharField | Dire√ß√£o (inbound/outbound) |
| `message_type` | CharField | Tipo (text, image, audio, video, document, etc) |
| `chat_id` | CharField | ID do chat/conversa |
| `contact_number` | CharField | N√∫mero do contato |
| `text_content` | TextField | Conte√∫do de texto |
| `media_url` | URLField | URL da m√≠dia (quando aplic√°vel) |
| `status` | CharField | Status (queued, sent, delivered, read, failed, error) |
| `queued_at` | DateTime | Data/hora de cria√ß√£o |
| `sent_at` | DateTime | Data/hora de envio |
| `delivered_at` | DateTime | Data/hora de entrega |
| `read_at` | DateTime | Data/hora de leitura |

#### Propriedades de Lat√™ncia

- `latency_to_sent_ms`: Lat√™ncia desde cria√ß√£o at√© envio (ms)
- `latency_to_delivered_ms`: Lat√™ncia desde cria√ß√£o at√© entrega (ms)
- `latency_to_read_ms`: Lat√™ncia desde cria√ß√£o at√© leitura (ms)
- `total_latency_ms`: Lat√™ncia total at√© status mais recente (ms)
- `is_latency_acceptable`: `True` se lat√™ncia < 5000ms (5 segundos)

#### M√©todos

- `mark_as_sent()`: Marca mensagem como enviada
- `mark_as_delivered()`: Marca mensagem como entregue
- `mark_as_read()`: Marca mensagem como lida
- `mark_as_error(error_msg)`: Marca mensagem com erro

---

## üîå Endpoints API

Base URL: `/api/v1/whatsapp/`

### Sess√µes

#### Listar Sess√µes
```http
GET /api/v1/whatsapp/sessions/
```

**Query Parameters:**
- `status`: Filtrar por status (disconnected, connecting, qrcode, ready, error)
- `is_active`: Filtrar sess√µes ativas (true/false)
- `search`: Buscar por n√∫mero de telefone ou nome do dispositivo

**Response:**
```json
{
  "count": 1,
  "results": [
    {
      "id": 1,
      "usuario": 1,
      "usuario_nome": "admin",
      "status": "ready",
      "phone_number": "5511999999999",
      "is_connected": true,
      "total_messages_sent": 150,
      "total_messages_received": 230,
      "last_message_at": "2025-10-11T10:30:00Z",
      "updated_at": "2025-10-11T10:30:00Z"
    }
  ]
}
```

---

#### Iniciar Sess√£o
```http
POST /api/v1/whatsapp/sessions/start/
```

**Response:**
```json
{
  "session_id": 1,
  "status": "connecting",
  "message": "Sess√£o iniciada com sucesso"
}
```

**Status Codes:**
- `202 Accepted`: Sess√£o iniciada
- `500 Internal Server Error`: Erro ao iniciar

---

#### Parar Sess√£o
```http
POST /api/v1/whatsapp/sessions/stop/
```

**Response:**
```json
{
  "message": "Sess√£o encerrada com sucesso"
}
```

---

#### Status da Sess√£o
```http
GET /api/v1/whatsapp/sessions/status/
```

**Response:**
```json
{
  "session_id": 1,
  "status": "ready",
  "is_connected": true,
  "phone_number": "5511999999999",
  "device_name": "DX Connect Web",
  "connected_at": "2025-10-11T08:00:00Z",
  "uptime_seconds": 9000,
  "total_messages_sent": 150,
  "total_messages_received": 230,
  "last_message_at": "2025-10-11T10:30:00Z",
  "error_count": 0
}
```

---

#### M√©tricas da Sess√£o
```http
GET /api/v1/whatsapp/sessions/{id}/metrics/
```

**Response:**
```json
{
  "session_id": 1,
  "total_messages": 380,
  "messages_sent": 150,
  "messages_received": 230,
  "messages_with_error": 2,
  "avg_latency_ms": 1250.5,
  "latency_acceptable_rate": 98.5,
  "uptime_seconds": 9000,
  "error_count": 0
}
```

---

### Mensagens

#### Listar Mensagens
```http
GET /api/v1/whatsapp/messages/
```

**Query Parameters:**
- `direction`: Filtrar por dire√ß√£o (inbound/outbound)
- `message_type`: Filtrar por tipo (text, image, audio, etc)
- `status`: Filtrar por status (queued, sent, delivered, read, error)
- `chat_id`: Filtrar por chat
- `session`: Filtrar por sess√£o
- `search`: Buscar em conte√∫do, n√∫mero ou nome do contato

**Response:**
```json
{
  "count": 380,
  "results": [
    {
      "id": 1,
      "message_id": "msg_abc123",
      "direction": "outbound",
      "message_type": "text",
      "contact_number": "5511988888888",
      "text_content": "Ol√°! Como posso ajudar?",
      "status": "read",
      "created_at": "2025-10-11T10:00:00Z",
      "total_latency_ms": 1230,
      "is_latency_acceptable": true
    }
  ]
}
```

---

#### Detalhar Mensagem
```http
GET /api/v1/whatsapp/messages/{id}/
```

**Response:**
```json
{
  "id": 1,
  "session": 1,
  "usuario": 1,
  "usuario_nome": "admin",
  "message_id": "msg_abc123",
  "client_message_id": "",
  "direction": "outbound",
  "message_type": "text",
  "chat_id": "5511988888888",
  "contact_number": "5511988888888",
  "contact_name": "Jo√£o Silva",
  "text_content": "Ol√°! Como posso ajudar?",
  "media_url": "",
  "status": "read",
  "created_at": "2025-10-11T10:00:00Z",
  "queued_at": "2025-10-11T10:00:00Z",
  "sent_at": "2025-10-11T10:00:01.230Z",
  "delivered_at": "2025-10-11T10:00:02.450Z",
  "read_at": "2025-10-11T10:00:05.120Z",
  "latency_to_sent_ms": 1230,
  "latency_to_delivered_ms": 2450,
  "latency_to_read_ms": 5120,
  "total_latency_ms": 5120,
  "is_latency_acceptable": false
}
```

---

#### Enviar Mensagem
```http
POST /api/v1/whatsapp/send/
```

**Request Body (Texto):**
```json
{
  "to": "5511988888888",
  "type": "text",
  "text": "Ol√°! Como posso ajudar?",
  "client_message_id": "my-custom-id-123"
}
```

**Request Body (Imagem):**
```json
{
  "to": "5511988888888",
  "type": "image",
  "media_url": "https://example.com/image.jpg",
  "text": "Legenda da imagem"
}
```

**Response:**
```json
{
  "message_id": "msg_xyz789",
  "database_id": 381,
  "status": "queued",
  "message": "Mensagem enfileirada para envio"
}
```

**Status Codes:**
- `202 Accepted`: Mensagem enfileirada
- `400 Bad Request`: Dados inv√°lidos
- `423 Locked`: Sess√£o n√£o est√° pronta
- `500 Internal Server Error`: Erro ao enviar

---

#### Mensagens com Alta Lat√™ncia
```http
GET /api/v1/whatsapp/messages/high-latency/
```

Lista mensagens que excederam o limite de 5 segundos.

**Response:**
```json
[
  {
    "id": 1,
    "message_id": "msg_slow",
    "direction": "outbound",
    "message_type": "text",
    "contact_number": "5511999999999",
    "text_content": "Mensagem lenta",
    "status": "sent",
    "created_at": "2025-10-11T10:00:00Z",
    "total_latency_ms": 7230,
    "is_latency_acceptable": false
  }
]
```

---

#### Estat√≠sticas de Lat√™ncia
```http
GET /api/v1/whatsapp/messages/latency-stats/
```

**Response:**
```json
{
  "total_messages": 380,
  "outbound_messages": 150,
  "inbound_messages": 230,
  "avg_latency_to_sent_ms": 1250.5,
  "avg_latency_to_delivered_ms": 2180.3,
  "messages_over_5s": 3,
  "latency_acceptable_rate": 98.0
}
```

---

## üîå WebSocket

### Conex√£o

```javascript
const token = 'your-jwt-token';
const ws = new WebSocket(`ws://localhost:8001/ws/whatsapp/?token=${token}`);
```

### Eventos Recebidos

#### 1. Status da Sess√£o
```json
{
  "type": "session_status",
  "status": "ready",
  "ts": "2025-10-11T10:00:00Z"
}
```

**Status Poss√≠veis:**
- `disconnected`: Desconectado
- `connecting`: Conectando
- `qrcode`: Aguardando leitura do QR Code
- `authenticated`: Autenticado
- `ready`: Pronto para enviar/receber mensagens
- `error`: Erro

---

#### 2. QR Code
```json
{
  "type": "qrcode",
  "image_b64": "base64-encoded-qr-code",
  "ts": "2025-10-11T10:00:05Z"
}
```

---

#### 3. Mensagem Recebida
```json
{
  "type": "message_received",
  "message_id": "msg_abc123",
  "from": "5511988888888",
  "chat_id": "5511988888888",
  "payload": {
    "type": "text",
    "text": "Ol√°! Preciso de ajuda",
    "contact_name": "Jo√£o Silva"
  },
  "ts": "2025-10-11T10:15:00Z"
}
```

---

#### 4. Status da Mensagem
```json
{
  "type": "message_status",
  "message_id": "msg_xyz789",
  "status": "delivered",
  "ts": "2025-10-11T10:00:02.450Z"
}
```

**Status Poss√≠veis:**
- `queued`: Na fila
- `sent`: Enviada
- `delivered`: Entregue
- `read`: Lida

---

### Ping/Pong

Para manter a conex√£o ativa:

**Enviar:**
```json
{
  "type": "ping"
}
```

**Receber:**
```json
{
  "type": "pong"
}
```

---

## üìà M√©tricas de Lat√™ncia

### Crit√©rios de Aceita√ß√£o

‚úÖ **Lat√™ncia Aceit√°vel**: < 5 segundos (5000ms)  
‚ùå **Lat√™ncia Alta**: ‚â• 5 segundos

### C√°lculos

1. **Lat√™ncia de Envio**: `sent_at - queued_at`
2. **Lat√™ncia de Entrega**: `delivered_at - queued_at`
3. **Lat√™ncia de Leitura**: `read_at - queued_at`
4. **Lat√™ncia Total**: At√© o status mais recente

### Logs

O sistema registra automaticamente:
- ‚úÖ Mensagens com lat√™ncia aceit√°vel (n√≠vel INFO)
- ‚ö†Ô∏è Mensagens com lat√™ncia alta (n√≠vel WARNING)

---

## üí° Exemplos de Uso

### Python (Requests)

#### Iniciar Sess√£o
```python
import requests

url = 'http://localhost:8001/api/v1/whatsapp/sessions/start/'
headers = {
    'Authorization': 'Bearer your-jwt-token',
    'Content-Type': 'application/json'
}

response = requests.post(url, headers=headers)
print(response.json())
# {'session_id': 1, 'status': 'connecting', 'message': 'Sess√£o iniciada com sucesso'}
```

#### Enviar Mensagem
```python
import requests

url = 'http://localhost:8001/api/v1/whatsapp/send/'
headers = {
    'Authorization': 'Bearer your-jwt-token',
    'Content-Type': 'application/json'
}
data = {
    'to': '5511988888888',
    'type': 'text',
    'text': 'Ol√°! Como posso ajudar?'
}

response = requests.post(url, json=data, headers=headers)
print(response.json())
# {'message_id': 'msg_xyz789', 'database_id': 1, 'status': 'queued'}
```

---

### JavaScript (Fetch)

#### Obter Status da Sess√£o
```javascript
const token = 'your-jwt-token';

fetch('http://localhost:8001/api/v1/whatsapp/sessions/status/', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => console.log(data));
// {session_id: 1, status: "ready", is_connected: true, ...}
```

#### WebSocket (Eventos)
```javascript
const token = 'your-jwt-token';
const ws = new WebSocket(`ws://localhost:8001/ws/whatsapp/?token=${token}`);

ws.onopen = () => {
  console.log('Conectado ao WebSocket');
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Evento recebido:', data);
  
  if (data.type === 'qrcode') {
    // Exibir QR Code
    console.log('QR Code:', data.image_b64);
  } else if (data.type === 'message_received') {
    // Processar mensagem recebida
    console.log('Nova mensagem:', data.payload.text);
  }
};
```

---

## üß™ Testes

### Executar Testes

```bash
# Todos os testes do app whatsapp
docker-compose exec web python manage.py test whatsapp

# Testes espec√≠ficos
docker-compose exec web python manage.py test whatsapp.tests.test_models
docker-compose exec web python manage.py test whatsapp.tests.test_views
docker-compose exec web python manage.py test whatsapp.tests.test_integration
```

### Cobertura de Testes

- ‚úÖ **Modelos**: CRUD, propriedades, m√©todos
- ‚úÖ **Views**: Endpoints, filtros, autentica√ß√£o
- ‚úÖ **Servi√ßos**: Gest√£o de sess√µes, envio/recebimento de mensagens
- ‚úÖ **Integra√ß√£o**: Ciclo completo de sess√£o e mensagens
- ‚úÖ **M√©tricas**: C√°lculo de lat√™ncia

---

## üìö Refer√™ncias

- **Issue**: #36 - WhatsApp Web - sess√£o e eventos (lat√™ncia < 5s)
- **Sprint**: 3 - Atendimento via Chat
- **Modelos**: `whatsapp/models.py`
- **Servi√ßo**: `whatsapp/service.py`
- **Views**: `whatsapp/views.py`
- **WebSocket**: `whatsapp/consumers.py`
- **Testes**: `whatsapp/tests/`

---

## üîÑ Pr√≥ximos Passos

1. **Issue #44**: WhatsApp: Recebimento de Mensagens (webhook)
2. **Issue #45**: WhatsApp: Envio de Mensagens (fila)
3. **Issue #46**: WhatsApp: Processamento de M√≠dias
4. **Issue #47**: WhatsApp: Gest√£o de Sess√µes e Conex√£o (completo)

